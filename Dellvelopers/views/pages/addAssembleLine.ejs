<form
  id="add-assembleLine-form"
  data-dds="form"
  class="mainContentAddManuais flex flex-col w-full h-auto px-4 md:px-12 gap-8"
>
  <nav id="breadcrumb-906636596" aria-label="breadcrumb">
    <ol id="breadcrumb-list-500396520-6" class="dds__breadcrumb">
      <li class="dds__breadcrumb__item">
        <a href="/assembleLine">
          <span
            class="dds__icon dds__icon--chevron-left dds__breadcrumb__chevron-left-icon"
            aria-hidden="true"
          ></span>
          Voltar para Linhas de Montagem
          <span class="dds__sr-only">Voltar para Linhas de Montagem</span>
        </a>
      </li>
      <li class="dds__breadcrumb__item">
        <a href="/addAssembleLine">Adicionar Linha de Montagem</a>
      </li>
    </ol>
  </nav>
  <div class="mainInformationManuais flex flex-col">
    <h2 class="mb-8">Adicionar Linhas de Montagem</h2>
    <div class="mainInformationManuaisContent flex flex-col w-full gap-5">
      <div id="text input-AssembleLineName" class="dds__input-text__container">
        <label
          id="text-input-label-AssembleLineName"
          for="text-input-control-AssembleLineName"
          class="dds__label dds__label--required"
          >Nome da Linha de Montagem</label
        >
        <div class="dds__input-text__wrapper">
          <input
            type="text"
            class="dds__input-text"
            placeholder="ex: Linha A"
            name="text-input-control-name-AssembleLineName"
            id="text-input-control-AssembleLineName"
            required="true"
            aria-labelledby="text-input-label-AssembleLineName text-input-helper-AssembleLineName"
          />
        </div>
      </div>
      <div class="dds__text-area__container" data-dds="text-area">
        <div class="dds__text-area__header">
          <label
            id="text-area-label-description"
            for="text-area-control-description"
            class="dds__label dds__label--required"
            >Descrição da Linha de Montagem</label
          >
        </div>
        <div class="dds__text-area__wrapper">
          <textarea
            class="dds__text-area"
            name="text-area-control-name-description"
            placeholder="Adicione uma descrição para a Linha de Montagem."
            id="text-area-control-description"
            data-maxlength="1000"
            maxlength="1000"
            aria-required="true"
            aria-labelledby="text-area-label-description text-area-helper-description"
            required=""
          ></textarea>
          <small id="text-area-error-description" class="dds__invalid-feedback"
            >Algo deu errado</small
          >
        </div>
      </div>
      <div class="dds__dropdown" data-dds="dropdown" id="dropdown-productType">
        <div class="dds__dropdown__input-container">
          <label
            id="dropdown-label-productType"
            for="dropdown-control-productType"
            class="dds__label"
            >Tipo de Produto</label
          >
          <div
            class="dds__dropdown__input-wrapper"
            autocomplete="off"
            aria-haspopup="listbox"
            aria-controls="dropdown-popup-productType"
          >
            <input
              id="dropdown-control-productType"
              name="dropdown-name"
              type="text"
              role="combobox"
              class="dds__dropdown__input-field"
              placeholder="Selecione o Tipo do Produto"
              aria-labelledby="dropdown-label-productType dropdown-helper-productType"
              autocomplete="off"
              aria-expanded="false"
              aria-controls="dropdown-popup-list-productType"
            />
          </div>
        </div>
        <div
          id="dropdown-popup-productType"
          class="dds__dropdown__popup dds__dropdown__popup--hidden"
          role="presentation"
          tabindex="-1"
        >
          <ul
            class="dds__dropdown__list"
            role="listbox"
            tabindex="-1"
            id="dropdown-popup-list-productType"
          >
            <li class="dds__dropdown__item" role="none">
              <button
                type="button"
                class="dds__dropdown__item-option"
                role="option"
                data-selected="false"
                data-value="Desktop"
                tabindex="-1"
              >
                <span class="dds__dropdown__item-label">Desktop</span>
              </button>
            </li>
            <li class="dds__dropdown__item" role="none">
              <button
                type="button"
                class="dds__dropdown__item-option"
                role="option"
                data-selected="false"
                data-value="Notebook"
                tabindex="-1"
              >
                <span class="dds__dropdown__item-label">Notebook</span>
              </button>
            </li>
            <li class="dds__dropdown__item" role="none">
              <button
                type="button"
                class="dds__dropdown__item-option"
                role="option"
                data-selected="false"
                data-value="Servidor"
                tabindex="-1"
              >
                <span class="dds__dropdown__item-label">Servidor</span>
              </button>
            </li>
          </ul>
        </div>
      </div>
      <div class="flex my-4 flex-col">
        <h3 class="mb-2">Associar funcionários</h3>
        <div class="dds__dropdown" data-dds="dropdown" id="dropdown-user">
          <div class="dds__dropdown__input-container">
            <label
              id="dropdown-label-user"
              for="dropdown-control-user"
              class="dds__label"
              >Funcionários</label
            >
            <div
              class="dds__dropdown__input-wrapper"
              autocomplete="off"
              aria-haspopup="listbox"
              aria-controls="dropdown-popup-user"
            >
              <input
                id="dropdown-control-user"
                name="dropdown-name"
                type="text"
                role="combobox"
                class="dds__dropdown__input-field"
                placeholder="ex: Maria José da Silva"
                aria-labelledby="dropdown-label-user dropdown-helper-user"
                autocomplete="off"
                aria-expanded="false"
                aria-controls="dropdown-popup-list-user"
              />
              <small
                id="dropdown-helper-associatedUser"
                class="dds__input-text__helper"
              >
                Selecione um ou mais funcionários para associar a linha de
                montagem
              </small>
            </div>
          </div>
          <div
            id="dropdown-popup-user"
            class="dds__dropdown__popup dds__dropdown__popup--hidden"
            role="presentation"
            tabindex="-1"
          >
            <ul
              class="dds__dropdown__list"
              role="listbox"
              tabindex="-1"
              id="dropdown-popup-list-user"
            ></ul>
          </div>
        </div>
      </div>
      <button
        id="submit-form-button"
        class="dds__button dds__form__submit w-full my-4"
        type="submit"
      >
        Adicionar Linha de Montagem
      </button>
    </div>
  </div>
</form>

<script>
  const dropdownProductType = document.getElementById('dropdown-productType');
  DDS.Dropdown(dropdownProductType, { selectAll: false });
  let productType = null;
  // Adiciona um evento ao dropdown para atualizar o valor selecionado na variável productType

  dropdownProductType.addEventListener(
    'ddsDropdownSelectionChangeEvent',
    (event) => {
      productType = event.detail.value;
    }
  );
    // Adiciona um evento ao dropdown para atualizar o ID do usuário selecionado
  const dropdownUser = document.getElementById('dropdown-user');
  let id_associatedUser = null;
  let listaDeUsers = [];

  dropdownUser.addEventListener('ddsDropdownSelectionChangeEvent', (event) => {
    id_associatedUser = event.detail.value;
  });
  // Função para buscar usuários da API e armazená-los em listaDeUsers
  const fetchUsers = async () => {
    try {
      const fetchResultUsers = await fetch('/users');
      listaDeUsers = await fetchResultUsers.json();
      renderUsers(); // Chama renderUsers para exibir os usuários no dropdown
    } catch (error) {
      console.error('Error fetching users:', error);
    }
  };
  // Função para renderizar a lista de usuários no dropdown
  const renderUsers = async () => {
    const usersOptions = document.getElementById('dropdown-popup-list-user');
    usersOptions.innerHTML = '';

    await listaDeUsers?.forEach((user) => {
      const usersElement = document.createElement('li');
      usersElement.id = user.id;
      usersElement.classList.add('dds__dropdown__item');
      usersElement.setAttribute('role', 'none');
      usersElement.innerHTML = `
              <button
                type="button"
                class="dds__dropdown__item-option"
                role="option"
                data-selected="false"
                data-value="${user.id}"
                tabindex="-1"
              >
                <span class="dds__dropdown__item-label">${user.name}</span>
              </button>
        `;

      usersOptions.appendChild(usersElement);
    });
    // Inicializa o dropdown com configurações específicas
    const dropdownUserAPI = DDS.Dropdown(dropdownUser, {
      selectAll: true,
      selection: 'multiple',
      noOptionsLabel: 'Nenhum funcionário encontrado',
      selectAllLabel: 'Selecionar todos',
      selectedLabel: 'Selecionado',
      srClearLabel: 'Limpar seleção',
    });
  };
  fetchUsers(); // Chama fetchUsers para buscar e renderizar os usuários
  // Adiciona um evento ao formulário para tratá-lo quando for submetido
  document.addEventListener('DOMContentLoaded', function () {
    document
      .getElementById('add-assembleLine-form')
      .addEventListener('submit', function (event) {
        event.preventDefault();

        submitButton = document.getElementById('submit-form-button');
        submitButton.disabled = true;

        const name = document.getElementById(
          'text-input-control-AssembleLineName'
        ).value;
        const description = document.getElementById(
          'text-area-control-description'
        ).value;
        // Envia os dados do formulário para a API
        fetch('/assembleLines', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name,
            description,
            productType,
            id_associatedUser: id_associatedUser.map((user) => parseInt(user)),
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            submitButton.disabled = false;
            alert('Linha de Montagem Criada com Sucesso!');
            document.getElementById('add-assembleLine-form').reset();
          })
          .catch((error) =>
            console.error('Erro em adicionar linha de montagem:', error)
          );
        submitButton.disabled = false; // Garante que o botão de submit seja reativado
      });
  });
</script>
